<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Implementation Summary: Dynamic Database Updates • ShinyImgVoteR</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Implementation Summary: Dynamic Database Updates"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">ShinyImgVoteR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Implementation Summary: Dynamic Database Updates</h1>

    </div>

<div id="implementation-summary-dynamic-database-updates" class="section level1">

<div class="section level2">
<h2 id="issue">Issue<a class="anchor" aria-label="anchor" href="#issue"></a></h2>
<p>The database of the shiny application was only populated when the app was started for the first time. The goal was to allow admins to update the database with new entries from the “to_be_voted_images_file” without restarting the application.</p>
</div>
<div class="section level2">
<h2 id="solution-overview">Solution Overview<a class="anchor" aria-label="anchor" href="#solution-overview"></a></h2>
<p>The implementation adds a manual update button in the admin panel that: 1. Allows admin users to trigger database updates on demand 2. Reads the <code>to_be_voted_images_file</code> (configured in <code>config.yaml</code>) 3. Updates the database with new entries 4. Prevents duplicate entries based on the unique combination of coordinates, REF, and ALT 5. Provides immediate feedback via modal dialog</p>
</div>
<div class="section level2">
<h2 id="technical-implementation">Technical Implementation<a class="anchor" aria-label="anchor" href="#technical-implementation"></a></h2>
<div class="section level3">
<h3 id="id_1-database-update-function-rdb_utilsr">1. Database Update Function (<code>R/db_utils.R</code>)<a class="anchor" aria-label="anchor" href="#id_1-database-update-function-rdb_utilsr"></a></h3>
<p>Added <code><a href="reference/update_annotations_table.html">update_annotations_table()</a></code> function that: - Reads the to_be_voted_images_file - Queries the database for existing entries - Creates unique keys (coordinates|REF|ALT) for comparison - Identifies and adds only new entries - Processes paths the same way as initial population - Returns the count of new entries added</p>
<p><strong>Key Features:</strong> - Duplicate prevention using composite key (coordinates + REF + ALT) - Handles multiple mutations at the same coordinates with different alleles - Error handling for missing files - Consistent path processing with initial database population</p>
</div>
<div class="section level3">
<h3 id="id_2-admin-panel-button-rmod_adminr">2. Admin Panel Button (<code>R/mod_admin.R</code>)<a class="anchor" aria-label="anchor" href="#id_2-admin-panel-button-rmod_adminr"></a></h3>
<p>Added “Update Database” button that: - Appears in the admin panel alongside other admin functions - Is only accessible to admin users - Triggers the database update when clicked - Shows a modal dialog with the results (success, no updates, or error)</p>
<p><strong>Implementation Details:</strong></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># In mod_admin.R - Button click handler</span></span>
<span><span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html" class="external-link">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">update_database_btn</span>, <span class="op">{</span></span>
<span>  <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html" class="external-link">req</a></span><span class="op">(</span><span class="fu">login_trigger</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">admin</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">conn</span> <span class="op">&lt;-</span> <span class="fu">pool</span><span class="fu">::</span><span class="fu"><a href="http://rstudio.github.io/pool/reference/poolCheckout.html" class="external-link">poolCheckout</a></span><span class="op">(</span><span class="va">db_pool</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu">pool</span><span class="fu">::</span><span class="fu"><a href="http://rstudio.github.io/pool/reference/poolCheckout.html" class="external-link">poolReturn</a></span><span class="op">(</span><span class="va">conn</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">new_entries_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/update_annotations_table.html">update_annotations_table</a></span><span class="op">(</span></span>
<span>    <span class="va">conn</span>,</span>
<span>    <span class="va">cfg</span><span class="op">$</span><span class="va">to_be_voted_images_file</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Show modal dialog with results</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_3-unit-tests-teststestthattest-database-updater">3. Unit Tests (<code>tests/testthat/test-database-update.R</code>)<a class="anchor" aria-label="anchor" href="#id_3-unit-tests-teststestthattest-database-updater"></a></h3>
<p>Comprehensive test suite covering: - Adding only new entries - Preventing duplicates - Handling duplicate coordinates with different REF/ALT - Error handling for missing files - Path processing - Multiple update scenarios</p>
</div>
<div class="section level3">
<h3 id="id_4-documentation">4. Documentation<a class="anchor" aria-label="anchor" href="#id_4-documentation"></a></h3>
<ul><li>
<strong>NEWS.md</strong>: Feature description in version 0.1.1 changelog</li>
<li>
<strong>README.md</strong>: User-facing documentation with usage examples</li>
<li>
<strong>dev_scripts/README.md</strong>: Testing instructions and manual testing guide</li>
<li>
<strong>dev_scripts/test_database_update.R</strong>: Script for manual testing</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="usage-example">Usage Example<a class="anchor" aria-label="anchor" href="#usage-example"></a></h2>
<ol style="list-style-type: decimal"><li>
<p>Start the application:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">make</span> run</span></code></pre></div>
</li>
<li>
<p>Add new entries to <code>./app_env/images/to_be_voted_images.tsv</code>:</p>
<pre class="tsv"><code>coordinates  REF ALT path
chr7:7000    A   G   ./app_env/images/pngs/new_image.png
chr8:8000    C   T   ./app_env/images/pngs/another_image.png</code></pre>
</li>
<li>
<p>Login as an admin user, navigate to the Admin panel, and click “Update Database”</p>
<ul><li>Console shows: “Added 2 new entries to annotations table”</li>
<li>Modal dialog shows: “Successfully added 2 new entries to the database”</li>
<li>New images are available for voting</li>
</ul></li>
</ol></div>
<div class="section level2">
<h2 id="benefits">Benefits<a class="anchor" aria-label="anchor" href="#benefits"></a></h2>
<ol style="list-style-type: decimal"><li>
<strong>No Downtime</strong>: Users can continue voting while new images are added</li>
<li>
<strong>On-Demand</strong>: Admin controls when database is updated</li>
<li>
<strong>Safe</strong>: Duplicate prevention ensures data integrity</li>
<li>
<strong>User-Friendly</strong>: Clear feedback via modal dialogs</li>
<li>
<strong>Efficient</strong>: Only new entries are processed and added</li>
</ol></div>
<div class="section level2">
<h2 id="edge-cases-handled">Edge Cases Handled<a class="anchor" aria-label="anchor" href="#edge-cases-handled"></a></h2>
<ol style="list-style-type: decimal"><li>
<strong>Duplicate Entries</strong>: Uses composite key to prevent duplicates</li>
<li>
<strong>Duplicate Coordinates</strong>: Handles multiple mutations at same position with different alleles</li>
<li>
<strong>File Removal</strong>: Gracefully handles if file is temporarily unavailable</li>
<li>
<strong>Parse Errors</strong>: Error handling with user notification</li>
<li>
<strong>Empty Updates</strong>: No notification if file changed but no new entries found</li>
</ol></div>
<div class="section level2">
<h2 id="performance-considerations">Performance Considerations<a class="anchor" aria-label="anchor" href="#performance-considerations"></a></h2>
<ul><li>Check interval: 5 seconds (configurable by changing <code>invalidateLater(5000)</code>)</li>
<li>Efficient duplicate detection using in-memory key comparison</li>
<li>Database connection pooling ensures efficient resource usage</li>
<li>Minimal overhead when file hasn’t changed</li>
</ul></div>
<div class="section level2">
<h2 id="future-enhancements-optional">Future Enhancements (Optional)<a class="anchor" aria-label="anchor" href="#future-enhancements-optional"></a></h2>
<ol style="list-style-type: decimal"><li>Make check interval configurable via config.yaml</li>
<li>Add file size threshold to warn about large updates</li>
<li>Log all update operations to a separate audit file</li>
<li>Add option to disable file watching if not needed</li>
<li>Support watching multiple files or directories</li>
</ol></div>
<div class="section level2">
<h2 id="testing-checklist">Testing Checklist<a class="anchor" aria-label="anchor" href="#testing-checklist"></a></h2>
<ul class="task-list"><li><label><input type="checkbox" checked>Unit tests for update_annotations_table()</label></li>
<li><label><input type="checkbox" checked>Test duplicate prevention</label></li>
<li><label><input type="checkbox" checked>Test with duplicate coordinates (different REF/ALT)</label></li>
<li><label><input type="checkbox" checked>Test error handling</label></li>
<li><label><input type="checkbox">Manual test with running app (requires R environment)</label></li>
<li><label><input type="checkbox">Test with large file updates (performance)</label></li>
<li><label><input type="checkbox">Test with concurrent user sessions</label></li>
</ul></div>
<div class="section level2">
<h2 id="files-modifiedcreated">Files Modified/Created<a class="anchor" aria-label="anchor" href="#files-modifiedcreated"></a></h2>
<div class="section level3">
<h3 id="core-implementation-3-files">Core Implementation (3 files)<a class="anchor" aria-label="anchor" href="#core-implementation-3-files"></a></h3>
<ul><li>
<code>R/db_utils.R</code>: Added <code><a href="reference/update_annotations_table.html">update_annotations_table()</a></code> function</li>
<li>
<code>R/main_server.R</code>: Added file watcher and update logic</li>
</ul></div>
<div class="section level3">
<h3 id="tests-1-file">Tests (1 file)<a class="anchor" aria-label="anchor" href="#tests-1-file"></a></h3>
<ul><li>
<code>tests/testthat/test-database-update.R</code>: Comprehensive unit tests</li>
</ul></div>
<div class="section level3">
<h3 id="documentation-3-files">Documentation (3 files)<a class="anchor" aria-label="anchor" href="#documentation-3-files"></a></h3>
<ul><li>
<code>NEWS.md</code>: Feature description</li>
<li>
<code>README.md</code>: User documentation</li>
<li>
<code>dev_scripts/README.md</code>: Testing guide</li>
<li>
<code>dev_scripts/test_database_update.R</code>: Manual test script</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="total-changes">Total Changes<a class="anchor" aria-label="anchor" href="#total-changes"></a></h2>
<ul><li>
<strong>523 lines</strong> added across 7 files</li>
<li>
<strong>0 lines</strong> deleted</li>
<li>All changes are additive and non-breaking</li>
</ul></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ivo Christopher Leist.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

